<template>
  <WindowFrame titleText="ユーザID選択画面" display-property="private.display.selectPeerWindow" align="center" fixSize="385, 300" :isBanClose="true">
    <div class="contents">
      <div>以下のルームメンバーが保存されていました。<br>あなたを選んでください。</div>
      <ul>
        <li v-for="memberObj in members" :key="memberObj.peerId"><label><input type="radio" name="peerId" :value="memberObj.peerId" v-model="currentPeerId" />{{memberObj.name}}({{memberObj.peerId}})</label></li>
      </ul>
      <div class="operateArea">
        <button @click="commit">決定</button>
      </div>
    </div>
  </WindowFrame>
</template>

<script>
import { mapActions, mapState } from "vuex";
import WindowFrame from "../WindowFrame";
import WindowMixin from "../WindowMixin";

export default {
  name: "selectPeerWindow",
  mixins: [WindowMixin],
  components: {
    WindowFrame
  },
  data() {
    return {
      currentPeerId: null
    };
  },
  methods: {
    ...mapActions(["windowClose", "setProperty", "createPeer", "windowOpen"]),
    commit() {
      quoridornLog(this.currentPeerId);
      const currentMemberObj = this.currentMemberObj;
      if (!currentMemberObj) {
        alert("ルームメンバーからあなたを選んでください。");
        return;
      }
      quoridornLog(currentMemberObj);
      const privateData = currentMemberObj.private;
      if (!privateData) {
        this.windowClose("private.display.selectPeerWindow");
        return;
      }
      this.setProperty({ property: `private`, value: privateData });

      const peerId = privateData.self.peerId;
      // TODO 引数修正
      this.createPeer({
        peerId: peerId,
        roomName: this.roomName
      });
      this.windowOpen("private.display.inviteLinkWindow");
      this.windowClose("private.display.selectPeerWindow");
    }
  },
  watch: {
    yourPeerId(yourPeerId) {
      this.currentPeerId = yourPeerId;
    }
  },
  computed: mapState({
    yourPeerId() {
      const privatePeerId = this.$store.state.private.self.peerId;
      if (privatePeerId) {
        const filtered = this.members.filter(
          memberObj => memberObj.peerId === privatePeerId
        );
        if (filtered.length > 0) {
          return privatePeerId;
        }
      }
      if (this.members.length > 0) {
        return this.members[0].peerId;
      }
      return null;
    },
    members: state => state.public.room.members,
    roomName: state => state.public.room.name,
    currentMemberObj() {
      return this.members.filter(
        memberObj => memberObj.peerId === this.currentPeerId
      )[0];
    }
  })
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
.contents {
  position: absolute;
  height: 100%;
  width: 100%;
  overflow-y: scroll;
  font-size: 12px;
}
</style>
